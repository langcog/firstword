
% Rose Schneider, Dan Yurovsky, Virginia Marchman, & Mike Frank
% `r as.character(format(Sys.Date(), format="%B %d, %Y"))`

Set up Rmd parameters
```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(cache=TRUE, message=FALSE, warning=FALSE)
```

Preliminaries.
```{r}
rm(list=ls())
library(ggplot2)
library(reshape2)
library(entropy)
library(pscl)
library(dplyr)
library(stringr)
library(tidyr)
library(markdown)
library(directlabels)
library(magrittr)


theme_set(theme_bw())
```

Read survey data.
```{r}
df_turk=read.csv("../data/FW_TurkData.csv") #Turk data
df_cdm=read.csv("../data/CDMlangsurvey_analysis.csv") #CDM data
df_info=read.csv("../data/FW_childesinfo.csv") #Childesinfo data

df_turk %<>%
  mutate(birth = factor(birth_order),
         age.grp = cut(age,breaks = c(5,10,14,18,24)),
         currage.grp = cut(age_current,breaks = c(-1,seq(2,18,2))),
         agesplit = cut(age,breaks = c(0,12,24)),
         dataset = "MTurk")

df_cdm$agesplit <- cut(df_cdm$age, breaks=c(0,12,24))
df_info$age.grp <- (cut(df_info$age, breaks = c(-0, seq(2, 30, 2))))
df_info$agesplit <- cut(df_info$age, breaks=c(0,12,24))

df_info %<>%
  mutate(currage.grp = cut(age_current, breaks = c(0, seq(2,50,2)))) # grouping current age for bias analysis

# #hacky stuff for reporting bias
# df_cdm$age.grp <- df_cdm$age
# df_cdm$currage.grp <- df_cdm$age_current
```

bind together
```{r}
df_cdm$dataset <- "CDM"
df_info$dataset <- "Info"

d <- bind_rows(df_turk,df_info) %>%
  mutate(age_current = as.character(age_current))

d <- bind_rows(d,df_cdm) %>%  #fixes an opaque binding problem for age_current
  rename(Category = cdi_cat)
```

Read in word descriptors
```{r}
wg.categories <- read.csv("../data/wg_categories.csv")
wg.codes <- read.csv("../data/WG_CODES.csv") 
childes.freqs <- read.csv('../data/childes.freqs.csv',check.names=FALSE) %>%
  gather(word,input.freq) %>%
  group_by(word) %>%
  summarise(input.freq = sum(input.freq))
#phon.complexity <- read.csv('../data/complexity_childesfreqs.csv')

# cmu.dict <- read.table('../data/cmudict-0.7b.txt',sep="\t",quote="",
#                        row.names=NULL,header=TRUE) %>%
#   filter(!str_detect(word,"[^[:alpha:]]") | word == "DON\'T") %>%
#   mutate(word = tolower(word))

mrc.phones <- read.table('../data/mrc.phons.txt',sep="\t",row.names=NULL,
                         header = TRUE,quote="",stringsAsFactors=FALSE)
```

Pull in wordbank demographics
```{r, message=FALSE}
wordbank <- src_mysql(dbname='wordbank',host="54.200.225.86", 
                      user="wordbank",password="wordbank")

## NOW LOAD TABLES ##
admin.table <- tbl(wordbank, "common_administration")
child.table <- tbl(wordbank,"common_child")
wg.table <- tbl(wordbank,"instruments_wg")

# Get the age of each child
admins <- admin.table %>%
  select(data_id,child_id,age,source_id) %>%
  rename(id = data_id, child.id = child_id,source.id = source_id) %>%
  as.data.frame

# Get demographic variables for each child
demos <- select(child.table,id,gender,mom_ed,birth_order) %>%
  as.data.frame %>%# Rename id fields
  rename(child.id = id) %>%
  mutate(gender = factor(gender,levels=c("F","M"),
                         labels=c("Female","Male")))


# Join age and demographics together
child.data <- as.tbl(left_join(admins,demos))
```

Pull in wordbank data
```{r}
# Select just the MCDI words from the Words and Sentences Table
wg.vocab.words <- select(wg.table,basetable_ptr_id,
                         col_baabaa:col_some) %>%
  as.data.frame %>%
  rename(id = basetable_ptr_id) %>% # Rename the id
  gather(word,produces,col_baabaa:col_some) %>% # Arrange in longform
  mutate(word = str_replace(word, "col_", "")) %>%
  as.tbl# Strip off col_ from words

wg.vocab.words <- left_join(wg.vocab.words,wg.categories,by=c("word"="Lemma"))
wg.vocab.words <- left_join(wg.vocab.words,child.data)

wg.vocab.words <- left_join(wg.vocab.words,wg.codes,
                                by = c("word"="code")) %>%
  select(-word) %>%
  rename(word = name)

one.word.kids <- wg.vocab.words%>% 
  group_by(id,age,gender) %>% 
  summarise(v = sum(produces==2)) %>% 
  filter(v == 1) %>%
  select(-v)

wds.produced.bykid <- wg.vocab.words %>% 
  filter(id %in% one.word.kids$id, produces==2) %>%
  select(-id,-produces) %>%
  mutate(agesplit = cut(age,breaks=c(0,12,24)),
         dataset = "Wordbank") 


# Compute a productive vocabulary for each child
wg.scores <- wg.vocab.words %>%
  group_by(id) %>% # Group by child
  summarise(productive = sum(produces == 2)) # Compute productive vocabulary

# Not using this anymore
# 
# all.first.productions <- c(as.character(
#   unique(filter(d,Category != "N/A")$word_standard)),
#   as.character(unique(wds.produced.bykid$word)))
# 
# all.first.productions <- unique(sapply(all.first.productions,tolower))
# write.csv(all.first.productions,'../data/unique.productions.csv',
#           row.names = FALSE)

# childes.freqs %<>%
#   gather(word,frequency) %>%
#   group_by(word) %>%
#   summarise(frequency = sum(frequency)) %>%
#   mutate(word = sapply(word,function(x) gsub("\\."," ",x)))
# 
# wds.produced.frequency <- wds.produced.bykid %>%
#   group_by(word) %>%
#   summarise(prod.frequency = n())
# 
# wds.produced.frequency <- left_join(wds.produced.frequency,childes.freqs)
# wds.produced.frequency <- left_join(wds.produced.frequency,phon.complexity,
#                                     by=c("word" = "Original.Word"))
# 
# cor(wds.produced.frequency$prod.frequency,
#     log(wds.produced.frequency$frequency),use="complete")
# 
# cor.test(wds.produced.frequency$prod.frequency,
#     wds.produced.frequency$unsBPAV,use="complete")
# 
# lm1 <- lm(prod.frequency ~ unsTPAV + log(frequency),data=wds.produced.frequency)
# lm2 <- lm(prod.frequency ~ unsTPAV,data=wds.produced.frequency)
# 
# quartz()
# ggplot(wds.produced.frequency, aes(x = word,y = prod.frequency)) + 
#   geom_bar(stat="identity")
```

Combine MDI data and demographics
```{r, message=FALSE}
wg.data <- left_join(wg.scores, child.data) %>%
  filter(age >= 8 & age <= 16) %>% # filter down to just relevant range
  select(-child.id,-source.id) #drop redundant columns
```


Do analysis over all data for CDI-cats.

```{r, fig.width=7,fig.height=7}
cat.by.age <- d %>%
  select(Category,agesplit,dataset,age,word_standard) %>%
  rename(word = word_standard)

cat.by.age <- bind_rows(cat.by.age,
                        select(wds.produced.bykid,
                               Category,agesplit,dataset,age,word)) %>%
#   filter(!is.na(agesplit), Category != "N/A", dataset == "MTurk" | 
#            dataset == "CDM" | dataset == "Info" & word != "Mama" &
#            word != "Dada" | dataset == "Wordbank") %>%
  filter(!is.na(agesplit), Category != "N/A") %>%
  group_by(dataset, agesplit, Category) %>%
  summarise(n = n()) %>%
  group_by(dataset, agesplit, add=FALSE) %>%
  mutate(prop = n / sum(n),
         Category = factor(Category,
                           levels = Category[order(prop,Category,
                                                   decreasing=TRUE)])) %>%
  filter(!is.na(Category=="NA")) %>%
  group_by() %>%
  mutate(agesplit = factor(agesplit,
                           labels=c("<12 Months Old", ">12 Months Old")))

#Plot
quartz(width=7,height=7)
ggplot(data = cat.by.age, 
       aes(x=Category, y=prop, fill=dataset, group=dataset)) + 
  facet_grid(dataset ~ agesplit)+
  geom_histogram(stat="identity") +
  ylab("Proportion of First Words") + 
  xlab("CDI Category") +
  scale_fill_brewer(palette="Set1") +
  theme_bw(base_size=14) +
  theme(axis.text.x = element_text(angle=90, hjust = 1,vjust=.5),
        axis.title.x = element_text(vjust=-.5),
        legend.position="none")
```


Top 5 words by dataset + agesplit
```{r}

d.age <- d %>%
  mutate(word = word_standard)


freqs <- bind_rows(select(d.age,word,dataset, agesplit),
                   select(wds.produced.bykid, word,dataset, agesplit)) %>%
  filter(!is.na(word), dataset == "MTurk" | dataset == "CDM" | dataset == "Info" & word != "Mama" & word != "Dada" & agesplit != "NA" | dataset == "Wordbank") %>%
  group_by(agesplit, dataset, word) %>%
  summarise(n=n()) %>%
  top_n(7) %>%
  arrange(n, dataset) %>%
  group_by(dataset, agesplit)
```

---
SES and age reporting biases for turk, cdm and info data

Age ~ current age 
```{r}
freqs <- bind_rows(select(d,age.grp, currage.grp,dataset)) %>%
  filter(age.grp != "NA", currage.grp != "NA", currage.grp != "0to3") %>%
  group_by(dataset, age.grp, currage.grp) %>%
  summarise(n=n()) %>%
  group_by(age.grp) %>%
  mutate(sum = sum(n), prop = n/sum)

##Test needs to be run

```

Plot!
```{r}
# quartz()
# ggplot(data = freqs, 
#        aes(x=word, y=prop, fill=dataset, 
#            group=dataset)) + 
#   facet_grid(dataset ~ agesplit)+
#   geom_histogram(stat="identity") +
#   ylab("Proportion of Total") + 
#   xlab("Word") +
#   scale_fill_brewer(palette="Set1") +
#   theme(axis.text.x = element_text(angle=90, hjust = 1))
```


Age CDF graphs --- with resampling!
--------------
First get wordbank CIs.
```{r}
n.samps <- 1000

wg.producers <- wg.data %>%
 group_by(age) %>%
  summarise(prop = sum(productive > 0)/n()) %>%
  mutate(dataset = "Wordbank")

sample.producers <- function(df) {
  df %<>%
    sample_n(nrow(df), replace = TRUE) %>% # resampling step
    group_by(age) %>%
    summarise(prop = sum(productive > 0)/n()) 
  return(df$prop)
}

samps <- replicate(n.samps, sample.producers(wg.data))
wg.producers$ci.low <- apply(samps, 1, function(x) {quantile(x, .025)})
wg.producers$ci.high <- apply(samps, 1, function(x) {quantile(x, .975)})
```

Now do the resampling for the others.

```{r}
ns <- d %>% 
  filter(!is.na(age), age != "NA", word_standard != "N/A") %>%
  mutate(dataset = factor(dataset), 
         age = floor(age)) %>%
  select(age, dataset)

sample.ns <- function(df) {
  df %<>% 
    sample_n(nrow(df), replace=TRUE) %>%
    group_by(dataset, age) %>%
    summarise(n = n()) %>%
    mutate(cum.n = cumsum(n),
         prop = cum.n / sum(n))
  return(df)
}

samps <- bind_rows(replicate(n.samps, sample.ns(ns), simplify=FALSE)) %>%
  group_by(dataset, age) %>%
  summarise(ci.low = quantile(prop, .025), 
            ci.high = quantile(prop, .975))

ns %<>% group_by(dataset, age) %>%
    summarise(n = n()) %>%
    mutate(cum.n = cumsum(n),
         prop = cum.n / sum(n))

ns <- left_join(ns, samps)
```

Bind these two and plot
```{r,fig.width=5,fig.height=4}
first.prod.cdfs <- bind_rows(ns, wg.producers)

quartz(width=5,height=4)
ggplot(data = freqs, 
       aes(x = age, y = prop, colour=dataset, fill=dataset,
           group=dataset))+
  geom_line(size=1) + 
  ylab("Cumulative Probability of First Word")+
  xlab("Age (months)") + 
  geom_hline(yintercept=.75, lty=3) + 
  geom_ribbon(aes(ymin = ci.low, ymax= ci.high), 
               alpha = .2,show_guide=FALSE,linetype=0) + 
  geom_vline(aes(xintercept=age[prop>.75][1]), lty=3) + 
  scale_x_continuous(breaks=seq(0,24,4))+
  scale_color_brewer(name="Dataset",palette="Set1")+
  scale_fill_brewer(palette="Set1")+
  theme_bw(base_size=14) +
  theme(legend.position=c(.85,.3)) 
```



First - Turk data
```{r}
#quartz()
freqs <- ddply(df_turk, .(cdi_cat, word_standard, agesplit), summarise, 
               count=length(word_standard)) 

#Normalizing within the age split
freqs <- freqs %>%
group_by(agesplit) %>%
mutate(prop = count/sum(count)) 
#sorting so that the graph looks cool
freqs$cdi_cat <- factor(freqs$cdi_cat, 
                                  levels=unique(with(freqs, cdi_cat
                                  [order(freqs$prop, cdi_cat, 
                                  decreasing = TRUE)])))
#plot of the proportion within the age split with CDI_cat as first word, faceted by the age split - note, N/A categories are excluded
qplot(cdi_cat, prop, geom="bar", position="dodge", stat="identity",
           data=subset(freqs, count>1 & word_standard != "N/A" & cdi_cat != "N/A" & agesplit != "NA")) + 
  theme(axis.text.x=element_text(angle=90, hjust=1, vjust=.5))+
  ylab("Proportion of Children with Utterance") + xlab("CDI Categories")+facet_wrap(~agesplit)
```

Second - CDM data 

```{r}
freqs <- ddply(df_cdm, .(cdi_cat, word_standard, agesplit), summarise, 
               count=length(word_standard))
#normalizing
freqs <- freqs %>%
group_by(agesplit) %>%
mutate(prop = count/sum(count)) 
#sorting
freqs$cdi_cat <- factor(freqs$cdi_cat, 
                                  levels=unique(with(freqs, cdi_cat
                                  [order(freqs$prop, cdi_cat, 
                                  decreasing = TRUE)])))

qplot(cdi_cat, prop, geom="bar", position="dodge", stat="identity",
           data=subset(freqs, count>1 & word_standard != "N/A" & cdi_cat != "N/A" & agesplit != "NA")) + 
  theme(axis.text.x=element_text(angle=90, hjust=1, vjust=.5))+
  ylab("Proportion of Children with Utterance") + xlab("CDI Categories")+facet_wrap(~agesplit)
```

Entropy
-------

Return samples for differences in entropy between groups
```{r}
entropy.diff.samps <- function(d,split.var,group.var,num.times) {
  
  if(!hasArg(num.times))
    num.times <- 1000
  
  # compute the size of the smaller group for fair entropy comparison
  grp.size <- d %>%
    group_by_(split.var,add=FALSE) %>%
    summarise(n = n()) %>%
    summarise(n = min(n)) %>%
    as.numeric
  
  sample.diff <- function(d) {
    d.frame <- d %>%
      group_by_(split.var,add = FALSE) %>%
      sample_n(grp.size, replace = TRUE) %>%
      group_by_(split.var, group.var, add = FALSE) %>%
      summarise(n = n()) %>%
      group_by_(split.var, add= FALSE) %>%
      summarise(h = entropy(n))
    
    diff <- d.frame[1,"h"] - d.frame[2,"h"]
    return(as.numeric(diff))
  }

  return(replicate(num.times, sample.diff(d)))
}
```

Start over categories. 

```{r}
all.data <- d %>%
  select(Category,agesplit,dataset,age,gender,word_standard,birth_order) %>%
  rename(word = word_standard)

all.data <- bind_rows(all.data,
                        select(wds.produced.bykid,
                               Category,agesplit,dataset,age,
                               gender,word,birth_order)) %>%
  filter(Category != "N/A", gender %in% c("Male","Female"),
         agesplit %in% c("(0,12]","(12,24]"),
         !is.na(birth_order)) %>%
  rename(birth.order = birth_order) %>%
  mutate(birth.order = ifelse(birth.order == 1,"First","Later"))

samp.grid.bo <- expand.grid(dataset=unique(all.data$dataset),
                         split.var=c("birth.order","agesplit"),
                         group.var=c("Category","word"),
                         stringsAsFactors=FALSE)

samp.helper <- function(set,split.var,group.var) 
  entropy.diff.samps(filter(all.data,dataset==set),
                     split.var,group.var)

ent.diffs <-mapply(samp.helper,samp.grid.bo$dataset,
                   samp.grid.bo$split.var,samp.grid.bo$group.var)

ent.samples <- cbind(samp.grid.bo,
                     as.data.frame(t(ent.diffs),rownames==NULL)) %>%
  gather(sample,value,V1:V1000) %>%
  group_by(dataset,split.var,group.var) %>%
  summarise(mean = mean(value),
            ci.high = quantile(value,.975),
            ci.low = quantile(value,.025))

quartz(width=6,height=5)
ggplot(data = ent.samples, 
       aes(x = dataset, y = mean, fill=dataset))+
  geom_histogram(stat="identity",position="identity")+
  geom_linerange(aes(ymax =ci.high,
                      ymin = ci.low)) +
  facet_grid(split.var ~ group.var)+
  ylab("Difference in First Word Distribution Entropy")+
  xlab("Dataset") + 
  geom_hline(yintercept=0, lty=2) + 
  #scale_color_brewer(name="Dataset",palette="Set1")+
  scale_fill_brewer(palette="Set1")+
  theme_bw(base_size=14) +
  theme(legend.position="none")
```

Now word entropy:

```{r}
d.age %>%
  filter(dataset=="MTurk", !is.na(age)) %>%
  mutate(older = age > median(age)) %>%
  group_by(older, add=FALSE) %>%
  sample_n(663, replace=FALSE) %>% ### FIXME: sample the smaller group size
  group_by(older, word, add=FALSE) %>%
  summarise(n = n()) %>% 
  group_by(older, add=FALSE) %>% 
  summarise(h = entropy(n))
```

Phonological complexity
```{r}
cdi.first.freq <- wds.produced.bykid %>%
  group_by(word) %>%
  summarise(n = n()) %>%
  mutate(dataset = "Wordbank")

d.first.freq <- d %>%
  select(word_standard,Category,dataset) %>%
  filter(Category != "N/A") %>%
  mutate(word = tolower(word_standard),
         subj = 1:nrow(.)) %>%
  group_by(subj) %>%
  mutate(word = if(word == "baba") "baa baa"
         else if(word == "bad dog") "dog"
         else if(word == "bike") "bicycle"
         else if(word == "bubble") "bubbles"
         else if(word == "choo") "choo choo"
         else if(word == "go dog") "dog"
         else if(word == "grandpa grandma hungry") "grandpa"
         else if(word == "kissy") "kiss"
         else if(word == "love you") "love"
         else if(word == "mama") "mommy"
         else if(word == "mama look") "mommy"
         else if(word == "mamas") "mommy"
         else if(word == "moocow") "cow"
         else if(word == "oh no") "uh oh"
         else if(word == "peek") "peekaboo"
         else if(word == "plane") "airplane"
         else if(word == "quack") "quack quack"
         else if(word == "want") "wanna"
         else if(word == "what's that") "what"
         else if(word == "woof") "woof woof"
         else if(word == "yeah") "yes"
         else if(word == "brown bear") "bear"
         else if(word == "more water") "water"
         else if(word == "yuck") "yucky"
         else if(word == "i love you") "love"
         else word) %>%
  filter(word %in% as.character(unique(mrc.phones$word))) %>%
  group_by(dataset,word) %>%
  summarise(n = n())%>%
  select(dataset,word,n)

all.first.freq <- bind_rows(cdi.first.freq,d.first.freq)

predictors <- expand.grid(word = childes.freqs$word,
                          dataset = unique(all.first.freq$dataset))
predictors <- left_join(predictors,childes.freqs)
predictors <- left_join(predictors,mrc.phones) %>%
  mutate(input.freq = ifelse(is.na(input.freq),0,input.freq))

all.first.freq <- left_join(predictors,all.first.freq) %>%
    mutate(n = ifelse(is.na(n),0,n))


datasets = unique(all.first.freq$dataset)
components = c("count","zero")
params = c("num.phones","log.freq")

predict.params <- expand.grid(dataset = datasets,
                              component = components,
                              param = params)%>%
  arrange(dataset,component,param)

outputs <- NULL

for(set in datasets)
  for(component in components) {
    hurd <- hurdle(n ~ phones + log(input.freq+1), 
                 data = filter(all.first.freq,dataset==set))

    model.outs <- summary(hurd)$coefficients[as.character(component)][[1]]
    
    outputs <- rbind(outputs,model.outs[c("phones","log(input.freq + 1)"),
                                        c("Estimate", "Std. Error","Pr(>|z|)")])
  }
colnames(outputs) = c("estimate","se","p")

predict.params <- cbind(predict.params,outputs) %>%
  mutate(ci = 1.96*se) %>%
  mutate(component = factor(component, labels = c("Count Estimate", "Hurdle")),
         param = factor(param, labels=c("Num. Phones", "Log Freq.")))


quartz(width=6,height=5)
ggplot(data = predict.params, 
       aes(x = dataset, y = estimate, fill=component))+
  geom_histogram(stat="identity",position="identity")+
  geom_linerange(aes(ymax =estimate+ci,
                      ymin = estimate-ci)) +
  facet_grid(component ~ param)+
  ylab("Parameter Estimate (+/- 95% CI)")+
  xlab("Dataset") + 
  geom_hline(yintercept=0, lty=2) + 
  #scale_color_brewer(name="Dataset",palette="Set1")+
  scale_fill_brewer(palette="Set1")+
  theme_bw(base_size=14) +
  theme(legend.position="none")
