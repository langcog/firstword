---
title: "FW_cogsci"
output: html_document
---

`r library(knitr)`
`r opts_chunk$set(message=FALSE, warning=FALSE)`

Preliminaries.
```{r}
rm(list=ls())
library(ggplot2)
library(plyr)
library(reshape2)
library(dplyr)
library(stringr)
library(tidyr)
library(markdown)
library(directlabels)
library(magrittr)

theme_set(theme_bw())
```

Read data.
```{r}
df_turk=read.csv("../data/FW_TurkData.csv") #Turk data
df_cdm=read.csv("../data/CDMlangsurvey_analysis.csv") #CDM data
df_info=read.csv("../data/FW_childesinfo.csv") #Childesinfo data
wg.categories <- read.csv("../data/wg_categories.csv")
wg.codes <- read.csv("../data/WG_CODES.csv") 
childes.freqs <- read.csv('../data/childes.freqs.csv')
phon.complexity <- read.csv('../data/complexity_childesfreqs.csv')

```

```{r}
df_turk %<>%
  mutate(birth = factor(birth_order),
         age.grp = cut(age,breaks = c(5,10,14,18,24)),
         currage.grp = cut(age_current,breaks = c(-1,seq(2,18,2))),
         agesplit = cut(age,breaks = c(0,12,24)),
         dataset = "MTurk")

df_cdm$agesplit <- cut(df_cdm$age, breaks=c(0,12,24))
df_info$agesplit <- cut(df_info$age, breaks=c(0,12,24))
```

bind together.
```{r}
df_cdm$dataset <- "CDM"
df_info$dataset <- "Info"

d <- rbind.fill(df_turk,df_cdm,df_info) %>%
  rename(Category = cdi_cat)
```

Pull in wordbank demographics
```{r, message=FALSE}
wordbank <- src_mysql(dbname='wordbank',host="54.200.225.86", 
                      user="wordbank",password="wordbank")

## NOW LOAD TABLES ##
admin.table <- tbl(wordbank,"common_administration")
child.table <- tbl(wordbank,"common_child")
wg.table <- tbl(wordbank,"instruments_wg")

# Get the age of each child
admins <- admin.table %>%
  select(data_id,child_id,age,source_id) %>%
  rename(id = data_id, child.id = child_id,source.id = source_id) %>%
  as.data.frame

# Get demographic variables for each child
demos <- select(child.table,id,gender,mom_ed,birth_order) %>%
  rename(child.id = id) %>%
  as.data.frame# Rename id fields

# Join age and demographics together
child.data <- as.tbl(left_join(admins,demos))
```

Pull in wordbank data
```{r}
# Select just the MCDI words from the Words and Sentences Table
wg.vocab.words <- select(wg.table,basetable_ptr_id,
                         col_baabaa:col_some) %>%
  as.data.frame %>%
  rename(id = basetable_ptr_id) %>% # Rename the id
  gather(word,produces,col_baabaa:col_some) %>% # Arrange in longform
  mutate(word = str_replace(word, "col_", "")) %>%
  as.tbl# Strip off col_ from words

wg.vocab.words <- left_join(wg.vocab.words,wg.categories,by=c("word"="Lemma"))
wg.vocab.words <- left_join(wg.vocab.words,child.data)

one.word.kids <- wg.vocab.words%>% 
  group_by(id,age,gender) %>% 
  summarise(v = sum(produces==2)) %>% 
  filter(v == 1) %>%
  select(-v)

wds.produced.bykid <- wg.vocab.words %>% 
  filter(id %in% one.word.kids$id, produces==2) %>%
  select(-id,-produces) %>%
  mutate(agesplit = cut(age,breaks=c(0,12,24)),
         dataset = "Wordbank") 

# pull in English-readable words
wds.produced.bykid <- left_join(wds.produced.bykid,wg.codes,
                                by = c("word"="code")) %>%
  select(-word) %>%
  rename(word = name)

# Compute a productive vocabulary for each child
wg.scores <- wg.vocab.words %>%
  group_by(id) %>% # Group by child
  summarise(productive = sum(produces == 2)) # Compute productive vocabulary

all.first.productions <- c(as.character(
  unique(filter(d,Category != "N/A")$word_standard)),
  as.character(unique(wds.produced.bykid$word)))

all.first.productions <- unique(sapply(all.first.productions,tolower))
write.csv(all.first.productions,'../data/unique.productions.csv',
          row.names = FALSE)

childes.freqs %<>%
  gather(word,frequency) %>%
  group_by(word) %>%
  summarise(frequency = sum(frequency)) %>%
  mutate(word = sapply(word,function(x) gsub("\\."," ",x)))



wds.produced.frequency <- wds.produced.bykid %>%
  group_by(word) %>%
  summarise(prod.frequency = n())

wds.produced.frequency <- left_join(wds.produced.frequency,childes.freqs)
wds.produced.frequency <- left_join(wds.produced.frequency,phon.complexity,
                                    by=c("word" = "Original.Word"))

cor(wds.produced.frequency$prod.frequency,
    log(wds.produced.frequency$frequency),use="complete")

cor.test(wds.produced.frequency$prod.frequency,
    wds.produced.frequency$unsBPAV,use="complete")

lm1 <- lm(prod.frequency ~ unsTPAV + log(frequency),data=wds.produced.frequency)
lm2 <- lm(prod.frequency ~ unsTPAV,data=wds.produced.frequency)

quartz()
ggplot(wds.produced.frequency, aes(x = word,y = prod.frequency)) + 
  geom_bar(stat="identity")
  
```

Combine MDI data and demographics
```{r, message=FALSE}
wg.data <- left_join(wg.scores, child.data) %>%
  filter(age >= 8 & age <= 16) %>% # filter down to just relevant range
  select(-child.id,-source.id) #drop redundant columns
```


Do analysis over all data for CDI-cats.
```{r}
freqs <- bind_rows(select(d,Category,agesplit,dataset),
                   select(wds.produced.bykid,Category,agesplit,dataset)) %>%
  filter(!is.na(agesplit),Category != "N/A") %>%
  group_by(dataset, agesplit, Category) %>%
  summarise(n = n()) %>%
  group_by(dataset, agesplit, add=FALSE) %>%
  mutate(prop = n / sum(n),
         Category = factor(Category,
                           levels = Category[order(prop,Category,
                                                   decreasing=TRUE)])) %>%
  filter(!is.na(Category=="NA"))
```

Plot.

```{r}
quartz()
ggplot(data = freqs, 
       aes(x=Category, y=prop, fill=dataset, 
           group=dataset)) + 
  facet_grid(dataset ~ agesplit)+
  geom_histogram(stat="identity") +
  ylab("Proportion of Total") + 
  xlab("MB-CDI Category") +
  scale_fill_brewer(palette="Set1") +
  theme(axis.text.x = element_text(angle=90, hjust = 1))
```


Agesplit and word
```{r}

d.age <- d %>%
  mutate(word = word_standard)

freqs <- bind_rows(select(d.age,word,agesplit,dataset),
                   select(wds.produced.bykid,word,agesplit,dataset)) %>%
  filter(!is.na(agesplit),word != "N/A") %>%
  group_by(dataset, agesplit, word) %>%
  summarise(n = n()) %>%
  filter(n > 4) %>%
  group_by(dataset, agesplit, add=FALSE) %>%
  mutate(prop = n / sum(n),
         word = factor(word,
                           levels = word[order(prop,word,
                                                   decreasing=TRUE)])) %>%
  filter(!is.na(word=="NA"))
```

Plot!
```{r}
quartz()
ggplot(data = freqs, 
       aes(x=word, y=prop, fill=dataset, 
           group=dataset)) + 
  facet_grid(dataset ~ agesplit)+
  geom_histogram(stat="identity") +
  ylab("Proportion of Total") + 
  xlab("Word") +
  scale_fill_brewer(palette="Set1") +
  theme(axis.text.x = element_text(angle=90, hjust = 1))
```

Age data - set that up. 
```{r}
wg.producers <- wg.data %>%
  group_by(age) %>%
  summarise(prop = sum(productive > 0)/n()) %>%
  mutate(dataset = "Wordbank")

ns <- d %>% 
  filter(!is.na(age), age != "NA", word_standard != "N/A") %>%
  mutate(dataset = factor(dataset), 
         age = floor(age)) %>%
  group_by(dataset, age) %>%
  summarise(n = n()) # round to the nearest complete month

freqs.grid <- expand.grid(dataset=c(levels(ns$dataset),"Wordbank"),
                          age=unique(ns$age)) %>%
  arrange(dataset,age)

freqs <- left_join(freqs.grid,ns) %>%
  filter(dataset == "MTurk" | dataset == "CDM" & age >= 10| 
           dataset == "Info" & age >=10 | dataset == "Wordbank" & age >= 8) %>%
  group_by() %>%
  mutate(n = ifelse(is.na(n), 0, n)) %>%
  group_by(dataset) %>%
  mutate(cum.n = cumsum(n),
         prop = cum.n / sum(n))

freqs <- left_join(freqs,wg.producers,by=c("dataset","age")) %>%
  group_by(dataset,age) %>%
  mutate(prop = min(prop.x,prop.y, 1,na.rm = TRUE)) %>%
  select(-prop.x,-prop.y)
```

Plot.
```{r,fig.width=5,fig.height=5}
quartz()
ggplot(data = freqs, 
       aes(x = age, y = prop, colour=dataset, group=dataset))+
  geom_line(size=1.5) + 
  ylab("Cumulative Probability of First Word")+
  xlab("Age (months)") + 
  geom_hline(yintercept=.75, lty=3) + 
  geom_vline(aes(xintercept=age[prop>.75][1]), lty=3) + 
  scale_x_continuous(breaks=seq(0,24,4))+
  scale_color_brewer(name="Dataset",palette="Set1")+
  theme_bw(base_size=14) +
  theme(legend.position=c(.85,.3)) 
```



First - Turk data

```{r}
#quartz()
freqs <- ddply(df_turk, .(cdi_cat, word_standard, agesplit), summarise, 
               count=length(word_standard)) 

#Normalizing within the age split
freqs <- freqs %>%
group_by(agesplit) %>%
mutate(prop = count/sum(count)) 
#sorting so that the graph looks cool
freqs$cdi_cat <- factor(freqs$cdi_cat, 
                                  levels=unique(with(freqs, cdi_cat
                                  [order(freqs$prop, cdi_cat, 
                                  decreasing = TRUE)])))
#plot of the proportion within the age split with CDI_cat as first word, faceted by the age split - note, N/A categories are excluded
qplot(cdi_cat, prop, geom="bar", position="dodge", stat="identity",
           data=subset(freqs, count>1 & word_standard != "N/A" & cdi_cat != "N/A" & agesplit != "NA")) + 
  theme(axis.text.x=element_text(angle=90, hjust=1, vjust=.5))+
  ylab("Proportion of Children with Utterance") + xlab("CDI Categories")+facet_wrap(~agesplit)
```

Second - CDM data 

```{r}
freqs <- ddply(df_cdm, .(cdi_cat, word_standard, agesplit), summarise, 
               count=length(word_standard))
#normalizing
freqs <- freqs %>%
group_by(agesplit) %>%
mutate(prop = count/sum(count)) 
#sorting
freqs$cdi_cat <- factor(freqs$cdi_cat, 
                                  levels=unique(with(freqs, cdi_cat
                                  [order(freqs$prop, cdi_cat, 
                                  decreasing = TRUE)])))

qplot(cdi_cat, prop, geom="bar", position="dodge", stat="identity",
           data=subset(freqs, count>1 & word_standard != "N/A" & cdi_cat != "N/A" & agesplit != "NA")) + 
  theme(axis.text.x=element_text(angle=90, hjust=1, vjust=.5))+
  ylab("Proportion of Children with Utterance") + xlab("CDI Categories")+facet_wrap(~agesplit)
```